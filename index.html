<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>Bugout demo server</title>

  <script src="js/libs/bugout.min.js" type="application/javascript"></script>
  <script src="js/libs/vue.js"></script>
  <script src="js/libs/app.js"></script>

</head>
<body>
  <a href="tut.html">tut</a>
<textarea id="api" rows="20"></textarea>
<button id="reload">reload</button>
<pre id="log"></pre>
</body>
<script>
  log("*BUGOUT*\n");
  log("Server log started.\n");

  // instantiate our bugout instance
  var b = new Bugout({seed: localStorage["bugout-demo-server-seed"]});

  // save the seed for next time
  localStorage.setItem("bugout-demo-server-seed",b.seed);

  // log this server's address
  log("\nThis browser tab is running a Bugout server.");
  log("This server's address:", b.address());
  log("announcing...");

  /*** logging ***/

  // log when network connectivity changes
  var connected = false;

  b.on("connections", function(c) {
    if (c == 0 && connected == false) {
      connected = true;
      log("ready");
      // link to the messageboard client URL
      var clientURL = document.location.href.replace("server.html", "") + "#" + b.address();
      // qrcode for the client URL
      log(clientURL + "\n");
      log("Connect back to this server-in-a-tab using the link above.");
    }
    log("connections:", c);
  });

  // log when a client sends a message
  b.on("message", function(address, msg) { log("message:", address, msg); });

  // log when a client makes an rpc call
  b.on("rpc", function(address, call, args) { log("rpc:", address, call, args); });

  // log when we see a new client address
  b.on("seen", function(address) { log("seen:", address); });

  b.register("ping", function(pk, args, cb) {
    log(pk)
    args["pong"] = true;
    cb(args);
  }, "Respond to ping with 'pong'.");

  // simple logging function
  function log() {
    var args = Array.prototype.slice.call(arguments);
    console.log.apply(null, args);

  }


</script>
<script id="api-source">// Bugout demo server API code
// Edit this to change the live API this server is running:

// respond to ping calls by sending back "pong"

</script>
<script>reload(document.getElementById("api-source").innerHTML);</script>
<style>
  body { background-color: #333; margin: 0px }
  pre { color: #eee; white-space: pre-wrap; word-wrap: break-word; line-height: 1em; margin: 1em; }
  #reload {
    border-radius: 5px;
    background-color: #008C28;
    color: white;
    border: none;
    padding: 0.25em 1em;
    font-size: 1.25em;
    margin: 0.5em;
  }
</style>
</html>
